_dark = "#141518"
_light = "#fff"

_jobs = {
	-- first responders
	["ems"] = {
		color = "#ce2029",
		txtColor = _light,
		icon = "star-of-life",
		location = {
			x = 1151.694,
            y = -1527.149,
            z = 34.844,
		},
	},
	-- misc
	["casino"] = {
		color = "#4C4CEE",
		txtColor = _light,
		icon = "cards",
		location = {
			x = 923.907,
			y = 47.325,
			z = 81.106,
		},
	},
	["pepega_pawn"] = {
		color = "#4C7DEE",
		txtColor = _light,
		icon = "store",
		location = {
			x = -295.913,
			y = -106.267,
			z = 47.051,
		},
	},
	["garcon_pawn"] = {
		color = "#4C7DEE",
		txtColor = _light,
		icon = "store",
		location = {
			x = -231.453,
            y = 6235.004,
            z = 31.496,
		},
	},
	["jewel"] = {
		color = "#B93636",
		txtColor = _light,
		icon = "gem",
		location = {
			x = -708.915,
			y = -886.714,
			z = 23.811,
		},
	},
	["vangelico"] = {
		color = "#B93636",
		txtColor = _light,
		icon = "gem",
		location = {
			x = -384.343,
			y = 6041.741,
			z = 31.500,
		},
	},
	["vangelico_grapeseed"] = {
		color = "#B93636",
		txtColor = _light,
		icon = "gem",
		location = {
			x = 1655.100,
            y = 4883.135,
            z = 41.968,
		},
	},
	["realestate"] = {
		color = "#E6CF1B",
		txtColor = _dark,
		icon = "building-user",
		location = {
			x = -708.261,
			y = 268.539,
			z = 83.140,
		},
	},
	["bowling"] = {
		color = "#EF71E1",
		txtColor = _dark,
		icon = "bowling-ball-pin",
		location = {
			x = 759.257,
			y = -777.503,
			z = 26.450,
		},
	},
	["securoserv"] = {
		color = "#66C566",
		txtColor = _dark,
		icon = "shield-halved",
		location = {
			x = 22.813,
			y = -123.661,
			z = 55.997,
		},
	},
	["rockford_records"] = {
		color = "#344EFD",
		txtColor = _light,
		icon = "record-vinyl",
		location = {
			x = -1007.663,
			y = -267.804,
			z = 39.034,
		},
	},
	["triad"] = {
		color = "#FA2913",
		txtColor = _light,
		icon = "record-vinyl",
		location = {
			x = -832.583,
			y = -698.636,
			z = 27.274,
		},
	},

	-- strip clubs
	["unicorn"] = {
		color = "#EE4CAD",
		txtColor = _light,
		icon = "martini-glass-citrus",
		location = {
			x = 131.215,
			y = -1302.595,
			z = 29.226,
		},
	},
	["bahama"] = {
		color = "#A058F7",
		txtColor = _light,
		icon = "martini-glass-citrus",
		location = {
			x = -1388.599,
			y = -586.613,
			z = 30.213,
		},
	},
	-- mechanics
	["ottos"] = {
		color = "#EF4A4A",
		txtColor = _light,
		icon = "gear",
		location = {
			x = 946.580,
			y = -988.297,
			z = 39.216,
		},
	},
	["hayes"] = {
		color = "#EF9A4A",
		txtColor = _light,
		icon = "gear",
		location = {
			x = -1418.533,
			y = -445.163,
			z = 35.917,
		},
	},
	["paleto_tuners"] = {
		color = "#00ff8c",
		txtColor = _dark,
		icon = "gear",
		location = {
            x = 149.057,
            y = 6393.512,
            z = 31.301,
		},
	},
	["auto_exotics"] = {
		color = "#00ff8c",
		txtColor = _dark,
		icon = "wheel",
		location = {
			x = 531.894,
            y = -182.602,
            z = 54.217,
		},
	},
	["dreamworks"] = {
		color = "#00ff8c",
		txtColor = _dark,
		icon = "gear",
		location = {
			x = -750.244,
            y = -1515.048,
            z = 5.049,
		},
	},
	["tuna"] = {
		color = "#B74CEE",
		txtColor = _dark,
		icon = "gear",
		location = {
			x = 161.993,
			y = -3036.946,
			z = 6.675,
		},
	},
	["bennys"] = {
		color = "#DE4CEE",
		txtColor = _light,
		icon = "gear",
		location = {
			x = -211.506,
			y = -1326.756,
			z = 31.294,
		},
	},
	["harmony"] = {
		color = "#399F34",
		txtColor = _light,
		icon = "gear",
		location = {
			x = 1179.980,
			y = 2649.063,
			z = 37.793,
		},
	},
	-- drift
	["cloud9"] = {
		color = "#4CC4EE",
		txtColor = _dark,
		icon = "car-side",
		location = {
			x = -27.380,
			y = -2544.857,
			z = 6.005,
		},
	},
	-- pdm
	["pdm"] = {
		color = "#346A9F",
		txtColor = _light,
		icon = "car-building",
		location = {
			x = -48.702,
			y = -1107.348,
			z = 26.670,
		},
	},
	-- foods/bars
	["beanmachine"] = {
		color = "#0EA050",
		txtColor = _light,
		icon = "coffee-beans",
		location = {
			x = 116.994,
			y = -1039.424,
			z = 29.271,
		},
	},
	["burgershot"] = {
		color = "#E59D2B",
		txtColor = _light,
		icon = "burger-soda",
		location = {
			x = -1183.508,
			y = -884.723,
			z = 13.80,
		},
	},
	["rustybrowns"] = {
		color = "#E59D2B",
		txtColor = _light,
		icon = "donut",
		location = {
			x = 147.984,
			y = 238.068,
			z = 106.936,
		},
	},
	["bakery"] = {
		color = "#E5BE2B",
		txtColor = _light,
		icon = "croissant",
		location = {
			x = -1255.271,
			y = -293.096,
			z = 37.376,
		},
	},
	["noodle"] = {
		color = "#2BE5E2",
		txtColor = _dark,
		icon = "bowl-chopsticks-noodles",
		location = {
			x = -1194.744,
			y = -1161.402,
			z = 7.685,
		},
	},
	["prego"] = {
		color = "#A271EF",
		txtColor = _light,
		icon = "pizza-slice",
		location = {
			x = -1114.852,
			y = -1452.908,
			z = 5.139,
		},
	},
	["pizza_this"] = {
		color = "#EF8F71",
		txtColor = _dark,
		icon = "pizza",
		location = {
			x = 793.909,
			y = -758.293,
			z = 26.786,
		},
	},
	["tequila"] = {
		color = "#FAE713",
		txtColor = _dark,
		icon = "beer-mug-empty",
		location = {
			x = -564.579,
			y = 276.162,
			z = 83.111,
		},
	},
	["lasttrain"] = {
		color = "#FA1313",
		txtColor = _dark,
		icon = "train",
		location = {
			x = -361.101,
			y = 275.100,
			z = 84.263,
		},
	},
	["uwu"] = {
		color = "#EC81E0",
		txtColor = _light,
		icon = "cat",
		location = {
			x = -581.104,
			y = -1070.052,
			z = 22.323,
		},
	},
}

function getJobIcon(jobId)
	return _jobs[jobId] and _jobs[jobId].icon
end

function getJobColor(jobId)
	return _jobs[jobId] and _jobs[jobId].color
end

function getTextColor(jobId)
	return _jobs[jobId] and _jobs[jobId].txtColor
end

function getJobLocation(jobId)
	return _jobs[jobId] and _jobs[jobId].location
end

function isBlacklistedJob(jobId)
	_blacklistedJobs = {
		["police"] = true,
		["prison"] = true,
		["ems"] = false,
		["dgang"] = true,
		["lsfc"] = true,
		["greycat_shipping"] = true,
		["government"] = true,
		["tow"] = true,
		["demonetti_storage"] = true
	}

	return _blacklistedJobs[jobId]
end

local CACHE_TIME = 60000 -- 1 Minute(s)
local cachedData = nil
local lastRefreshed = 0

-- Only Run Expensive Stuff Every Minute For Everyone Because No Point Spamming It
function RefreshServicesDataPls()
	if cachedData == nil or (GetGameTimer() - lastRefreshed) >= CACHE_TIME then
		local onlineShit = {}

		for _, char in pairs(Fetch:AllCharacters()) do
			if char ~= nil then
				local src = char:GetData("Source")

				local onDuty = Player(src).state.onDuty
				if onDuty and not isBlacklistedJob(onDuty) then
					local jobData = Jobs:Get(onDuty)
					if jobData and jobData.Id == onDuty and not jobData.Hidden then
						local bizPhone = GlobalState.BizPhones[jobData.Id]

						if not onlineShit[jobData.Id] then
							onlineShit[jobData.Id] = {
								jobName = jobData.Id,
								jobLabel = jobData.Name,
								jobIcon = getJobIcon(jobData.Id),
								jobColor = "#333333", --getJobColor(jobData.Id)
								jobTextColor = "#fff", --getTextColor(jobData.Id)
								jobLocation = getJobLocation(jobData.Id),
								players = {},
								phoneNumber = bizPhone?.number,
							}
						end

						table.insert(onlineShit[jobData.Id].players, {
							playerId = char:GetData("SID"),
							playerNumber = char:GetData("Phone"),
							playerName = string.format("%s %s", char:GetData("First"), char:GetData("Last")),
							playerStatus = Player(src).state.inDutyZone and 1 or 0,
						})
					end
				end
			end
		end

		local res = {}
		for k, v in pairs(onlineShit) do
			table.insert(res, v)
		end

		table.sort(res, function(a, b)
			return a.jobLabel < b.jobLabel
		end)

		cachedData = res
		lastRefreshed = GetGameTimer()
	end
end

AddEventHandler("Phone:Server:RegisterCallbacks", function()
	Callbacks:RegisterServerCallback("Phone:Services:GetServices", function(source, data, cb)
		RefreshServicesDataPls()
		cb(cachedData)
	end)
end)
